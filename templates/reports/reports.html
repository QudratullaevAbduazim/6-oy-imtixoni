{% extends 'base.html' %}

{% block content %}
<div class="container-fluid py-4">
    <div class="card border-0 shadow-sm mb-4 rounded-4">
        <div class="card-body">
            <form method="GET" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small fw-bold">Dan (sana)</label>
                    <input type="date" name="start_date" class="form-control form-control-sm" value="{{ start_date }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold">Gacha (sana)</label>
                    <input type="date" name="end_date" class="form-control form-control-sm" value="{{ end_date }}">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary btn-sm w-100 rounded-3">Ko'rsatish</button>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="btn-group shadow-sm p-1 bg-light rounded-pill">
                        <a href="?period=day" class="btn btn-sm rounded-pill {% if period == 'day' %}btn-primary{% else %}btn-light{% endif %}">Kun</a>
                        <a href="?period=week" class="btn btn-sm rounded-pill {% if period == 'week' %}btn-primary{% else %}btn-light{% endif %}">Hafta</a>
                        <a href="?period=month" class="btn btn-sm rounded-pill {% if period == 'month' %}btn-primary{% else %}btn-light{% endif %}">Oy</a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card border-0 bg-success text-white shadow-sm rounded-4 p-3 text-center">
                <p class="mb-1 opacity-75 small">Jami Kirim</p>
                <h3 class="fw-bold mb-0">+{{ income|floatformat:0 }} <small>UZS</small></h3>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 bg-danger text-white shadow-sm rounded-4 p-3 text-center">
                <p class="mb-1 opacity-75 small">Jami Chiqim</p>
                <h3 class="fw-bold mb-0">-{{ expense|floatformat:0 }} <small>UZS</small></h3>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 bg-info text-white shadow-sm rounded-4 p-3 text-center">
                <p class="mb-1 opacity-75 small">Sof Foyda</p>
                <h3 class="fw-bold mb-0">{{ balance|floatformat:0 }} <small>UZS</small></h3>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-5 mb-4">
            <div class="card border-0 shadow-sm rounded-4 p-4 h-100 bg-white text-center">
                <h5 class="fw-bold text-start mb-4 border-bottom pb-2">Xarajatlar tahlili</h5>
                {% if category_data %}
                    <div style="height: 300px;">
                        <canvas id="expenseChart"></canvas>
                    </div>
                {% else %}
                    <div class="py-5">
                        <i class="fas fa-chart-pie fa-3x text-light mb-3"></i>
                        <p class="text-muted">Ma'lumot mavjud emas</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="col-lg-7 mb-4">
            <div class="card border-0 shadow-sm rounded-4 p-4 h-100 bg-white">
                <h5 class="fw-bold mb-4 border-bottom pb-2">Amallar tarixi</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="small text-muted">
                            <tr>
                                <th>Sana</th>
                                <th>Kategoriya</th>
                                <th class="text-end">Summa</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trans in transactions %}
                            <tr>
                                <td class="small">{{ trans.date|date:"d.m.Y H:i" }}</td>
                                <td><span class="badge bg-light text-dark rounded-pill border">{{ trans.category.name }}</span></td>
                                <td class="text-end fw-bold {% if trans.category.kind == 'in' %}text-success{% else %}text-danger{% endif %}">
                                    {% if trans.category.kind == 'in' %}+{% else %}-{% endif %}{{ trans.amount|floatformat:0 }}
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="text-center py-4 text-muted">Tranzaksiyalar yo'q</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    {% if category_data %}
    const ctx = document.getElementById('expenseChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: [{% for item in category_data %}"{{ item.category__name }}",{% endfor %}],
            datasets: [{
                data: [{% for item in category_data %}{{ item.total }},{% endfor %}],
                backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796', '#5a5c69'],
                hoverOffset: 20,
                borderWidth: 0
            }]
        },
        options: {
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } },
            cutout: '75%'
        }
    });
    {% endif %}
</script>
{% endblock %}